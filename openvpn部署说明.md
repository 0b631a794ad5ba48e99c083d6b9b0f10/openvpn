
[TOC]

### openvpn部署文档

> 安装环境

```
服务端      centos 7.2*1     10.17.0.10
客户端      centos 7.2*1     10.50.5.10
```

#### 1 服务端部署

##### 1.1 安装服务端
- 使用一键安装脚本，交互输入说明如下，执行过程中一直回车即可
```shell
sh openvpn-install.sh 

>IP address: #脚本自动捕获
>Protocol [1-2]:1 #选择默认的udp协议
>Port: 1194 #默认端口
>DNS [1-5]: 1 #默认DNS
>Client name: client #客户端配置文件名字,按需修改
```

- 脚本运行完，执行`service iptables save`查看nat转发规则

```
# Generated by iptables-save v1.4.7 on Wed Oct 24 16:43:36 2018
*nat
:PREROUTING ACCEPT [254:26292]
:POSTROUTING ACCEPT [129:9143]
:OUTPUT ACCEPT [129:9143]
-A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to-source 10.17.0.10
COMMIT
```

- 调整安全组和iptables，放行udp:1194


##### 1.2 修改配置文件

- 服务端配置文件`/etc/openvpn/server.conf`

```shell
默认配置基础下添加

>duplicate-cn #允许多个客户端同时连接，为客户端分配不同的ip
```

服务端配置文件修改完，需要重启openvpn

```
systemctl restart  openvpn@server.service
```

- 客户端配置文件`/root/client.ovpn`

```shell
默认配置基础下添加

>route-nopull   
>route 10.17.0.0 255.255.0.0  vpn_gateway  
#默认访问网络不走vpn隧道,下发该路由后访问目的网络会自动进入VPN隧道
```

至此服务端搭建完成

---

#### 2 客户端部署

##### 2.1 安装客户端

- yum安装

```shell
yum -y install epel-release
yum -y install openvpn
```

- 添加配置文件和证书

将服务端`/etc/openvpn`目录下的`ca.crt` `ta.key` `client.ovpn`文件拷贝到客户端
```shell
[root@bear2 /etc/openvpn]#tree . 
.
├── client
│   ├── ca.crt      #服务端提供
│   └── ta.key      #服务端提供
├── server
└── client.ovpn     #服务端提供
```

##### 2.2 连接服务端

```shell
openvpn --daemon --config /etc/openvpn/usmhmnz.ovpn --log-append /var/log/openvpn.log
```

连接后`ifconfig`后有一个`tun0`的虚拟网口，查看`route -n`会有对应访问服务端的路由规则

```
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10.8.0.0        0.0.0.0         255.255.255.0   U     0      0        0 tun0
10.17.0.0       10.8.0.1        255.255.0.0     UG    0      0        0 tun0
```

##### 2.3 业务测试

以韩国梦战迁移业务为例，客户端(腾讯云)拨vpn后，可以访问服务端(Ucloud)网段下mongodb的27017端口